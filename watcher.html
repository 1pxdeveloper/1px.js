<!DOCTYPE html>
<html>
<head lang="en">
</head>


<body>
<pre id="output"></pre>

<script>

	var $setImmediate = window.requestAnimationFrame;
	var $hashmap = new WeakMap();

	function noop(){}

	/// @TODO: 이거 옛날 브라우저에 돌아가는 방법 고려해보자.
	function isDOM(o) {
		return (
				typeof Node === "object" ? o instanceof Node :
				o && typeof o === "object" && typeof o.nodeType === "number" && typeof o.nodeName === "string"
		);
	}

	function $nextProcess() {
		$setImmediate(this);
	}

	function $createPathObserver(props, shadow, object) {
		return function(key) {
			props[key] = undefined;
			shadow[key] = object[key];
		}
	}

	function $observe(object, callback) {
		if (Object(object) !== object) {
			return;
		}
		if (object === window || object === document || isDOM(object)) {
			return;
		}

		var props = {};
		var shadow = Object.create(object);

		function $watcher() {
			var flag = false;
			var changes = {};

			for (var prop in props) {
				var oldValue = shadow[prop];
				var newValue = object[prop];

				if (oldValue !== newValue && !(oldValue !== oldValue && newValue !== newValue)) {
					flag = true;
					changes[prop] = {oldValue: oldValue, newValue: newValue};
					shadow[prop] = newValue;
				}
			}

			if (flag === true) {
				callback(changes);
			}

			$watcher.$next();
		}
		$watcher.$next = $nextProcess;

		$hashmap.set(object, $watcher);
		$watcher.$next();
		return $createPathObserver(props, shadow, object);
	}

	function $unobserve(object) {
		if (Object(object) !== object) {
			return;
		}

		if ($hashmap.has(object) === false) {
			return;
		}

		$hashmap.get(object).$next = noop;
		$hashmap["delete"](object);
	}


	var $output = document.getElementById("output");
	var a = [1, 2, 3];

	var addPath = $observe(a, output);

	function output(changes) {
		console.log(changes);
		$output.innerText = JSON.stringify(changes);
	}

	function test() {
		a.foo = "sadlkfjalskf";
		a.bar = "asdklfjaklsdfad";
		a.baz = "asdklfjalsdf";
	}


</script>


</body>
</html>