<!doctype html>
<html lang="en" module="module">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>1px.js • TodoMVC</title>
	<!--<link rel="stylesheet" href="node_modules/todomvc-common/base.css">-->
	<!--<link rel="stylesheet" href="node_modules/todomvc-app-css/index.css">-->
	<!-- CSS overrides - remove if you don't need it -->
	<link rel="stylesheet" href="css/app.css">

	<script src="../../js/observable.js"></script>
	<script src="../../js/module.js"></script>
	<script src="../../js/parse.js"></script>
	<script src="../../js/compile.js"></script>
	<script src="../../js/component.js"></script>
	<script src="../../js/util.js"></script>
</head>
<body>

<todo-app></todo-app>

<web-component name="todo-app">
	<template id="todo-app">
		<section class="todoapp">
			<header class="header">
				<h1>todos</h1>
				<form #form (submit)="addTodo(form.newTodo.value); form.reset()">
					<input name="newTodo" class="new-todo" placeholder="What needs to be done?" autofocus>
				</form>
			</header>

			<!-- This section should be hidden by default and shown when there are todos -->
			<section class="main" [hidden]="todos.length === 0">
				<input id="toggle-all" class="toggle-all" type="checkbox" [(checked)]="allChecked" (input)="toggleAll(allChecked)">
				<label for="toggle-all">Mark all as complete</label>
				<ul class="todo-list">
					<li *repeat="todos as todo, index" [hidden]="!checkFilter(filter, todo.completed)"
							[class.completed]="todo.completed" [class.editing]="editingTodo === todo">
						<div class="view">
							<input class="toggle" type="checkbox" [(checked)]="todo.completed">
							<label (dblclick)="setEditingTodo(todo);">{{ todo.title }}</label>
							<button class="destroy" (click)="removeTodo(todo)"></button>
						</div>
						<input #title class="edit" [value]="todo_title" (change)="commitTodo(todo, title.value) if editingTodo"
								(keydown|esc)="revertTodo(todo)" .focus()="editingTodo === todo">
					</li>
				</ul>
			</section>

			<!-- This footer should hidden by default and shown when there are todos -->
			<footer class="footer" [hidden]="todos.length === 0">
				<!-- This should be `0 items left` by default -->
				<span class="todo-count"><strong>{{ num_items_left || 0 }}</strong> item{{ num_items_left !== 1 ? 's': '' }} left</span>
				<!-- Remove this if you don't implement routing -->
				<ul class="filters">
					<li>
						<a [class.selected]="filter === 'all'" href="#/">All</a>
					</li>
					<li>
						<a [class.selected]="filter === 'active'" href="#/active">Active</a>
					</li>
					<li>
						<a [class.selected]="filter === 'completed'" href="#/completed">Completed</a>
					</li>
				</ul>
				<!-- Hidden if no completed items are left ↓ -->
				<button class="clear-completed" [hidden]="num_items_left> 0" (click)="clearCompleted()">Clear completed</button>
			</footer>
		</section>
	</template>
</web-component>

<script>
module.component("todo-app", function($localStorage) {

	const $store = $localStorage("todomvc-1px");

	return {
		init($) {
			this.todos = $store.todos = $store.todos || [];

			this.allChecked = null;
			this.num_items_left = null;
			this.editingTodo = null;

			/// Computed
			$`this.num_items_left = todos.filter(todo => !todo.completed).length;`;
			$`this.allChecked = !num_items_left`;

			/// localStorage Auto Save
			$`todos.forEach(todo => todo.title; todo.completed)`.subscribe($store.save);


			/// Filter @TODO: Route Service
			this.filter = "all";
			let route = () => {
				let hash = location.hash || "#/";
				this[hash] && this[hash]();
			};

			$.on$(window, "popstate").subscribe(route);
			route();
		},

		/// Route Service
		"#/": function() {
			this.filter = "all";
		},

		"#/active": function() {
			this.filter = "active";
		},

		"#/completed": function() {
			this.filter = "completed";
		},


		/// Methods
		checkFilter(filter, completed) {
			switch (filter) {
				case "active":
					return !completed;

				case "completed":
					return completed;
			}

			return true;
		},

		addTodo(title) {
			title = title.trim();
			if (!title) return;

			this.todos.unshift({
				title: title,
				completed: false,
			});
		},

		toggleAll(allChecked) {
			this.todos.forEach(todo => todo.completed = allChecked);
		},

		removeTodo(todo) {
			let index = this.todos.indexOf(todo);
			if (index >= 0) this.todos.splice(index, 1);
		},

		setEditingTodo(todo) {
			this.editingTodo = todo;
			this.todo_title = todo.title;
		},

		commitTodo(todo, title) {
			if (!this.editingTodo) return;
			this.editingTodo = null;

			title = (title || "").trim();
			if (!title) return this.removeTodo(todo);
			todo.title = title;
		},

		revertTodo() {
			this.editingTodo = null;
			this.todo_title = null;
		},

		clearCompleted() {
			this.todos = this.todos.filter(todo => !todo.completed);
		}
	}
});
</script>


<!-- Scripts here. Don't remove ↓ -->
<!--<script src="node_modules/todomvc-common/base.js0"></script>-->
<script src="js/app.js"></script>
</body>
</html>
