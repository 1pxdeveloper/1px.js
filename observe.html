<!DOCTYPE html>
<html>
<head lang="en">
</head>


<body>
<pre id="output"></pre>

<script>

	var $setImmediate = window.requestAnimationFrame;
	var $hashmap = new WeakMap();

	/// @TODO: 이거 옛날 브라우저에 돌아가는 방법 고려해보자.
	function isDOM(o) {
		return (
				typeof Node === "object" ? o instanceof Node :
				o && typeof o === "object" && typeof o.nodeType === "number" && typeof o.nodeName === "string"
		);
	}

	function $observe(object, callback) {
		if (Object(object) !== object) {
			return;
		}
		if (object === window || object === document || isDOM(object)) {
			return;
		}

		var shadow = Object.create(object);
		var props = Object.create(shadow);
		for (var prop in object) {
			shadow[prop] = object[prop];
		}

		function $watcher() {
			var changes = {};
			var flag = false;

			for (var prop in props) {
				var oldValue = shadow[prop];
				var newValue = object[prop];

				/// @TODO: isSame에서 NaN 처리 루틴필요~
				if ((oldValue !== newValue && oldValue !== oldValue && newValue !== newValue) || shadow.hasOwnProperty(prop) === false) {
					changes[prop] = {oldValue: oldValue, newValue: newValue};
					flag = true;

					$unobserve(oldValue);
					$observe(newValue, callback);
				}
				shadow[prop] = newValue;
			}

			if (flag === true) {
				callback(changes);
			}

			if ($watcher.obserable === true) {
				$setImmediate($watcher);
			}
		}

		$watcher.obserable = true;

		$hashmap.set(object, $watcher);

		$setImmediate($watcher);
	}

	function $unobserve(object) {
		if (Object(object) !== object) {
			return;
		}

		if ($hashmap.has(object) === false) {
			return;
		}

		$hashmap.get(object).obserable = false;
		for (var prop in object) {
			if (object.hasOwnProperty(prop)) {
				var value = object[prop];
				$unobserve(value);
			}
		}

		$hashmap["delete"](object);
	}


	var $output = document.getElementById("output");
	var a = [1, 2, 3];

	$observe(a, function(changes) {
		console.log(changes);
		$output.innerText = JSON.stringify(changes);
	});

	function test() {
		a.foo = "sadlkfjalskf";
		a.bar = "asdklfjaklsdfad";
		a.baz = "asdklfjalsdf";
	}

</script>


</body>
</html>