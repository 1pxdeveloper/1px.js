<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<script src="js4/observable.js"></script>
	<!--<script src="js4/watch.js"></script>-->
	<!--<script src="js4/module.js"></script>-->
	<!--<script src="js4/parse.js"></script>-->
	<!--<script src="js4/compile.js"></script>-->
</head>
<body>


<script>

	function createFactoryFromArray(array) {
		array = array.slice();
		let factory = array.pop();
		if (typeof factory !== "function") {
			throw SyntaxError(array);
		}

		factory.$inject = array;
		factory.$inject.values = Object.create(null);
		return factory;
	}

	function createFactoryFromFunction(factory) {
		if (typeof factory !== "function") {
			throw TypeError('factory is must be function.');
		}

		if (Array.isArray(factory.$inject)) {
			return factory;
		}

		if (factory.length === 0) {
			factory.$inject = [];
			factory.$inject.values = Object.create(null);
			return factory;
		}

		let injector = factory.toString().match(/\([^)]*\)/m)[0];
		factory.$inject = injector.slice(1, -1).split(/\s*,\s*/);
		factory.$inject.values = Object.create(null);
		return factory;
	}

	function createFactory(mixed) {
		if (typeof mixed === "function") {
			return createFactoryFromFunction(mixed);
		}

		if (Array.isArray(mixed)) {
			return createFactoryFromArray(mixed);
		}

		throw SyntaxError(mixed);
	}


	function invokeFactory(factory, args, index, callback) {
		if (index >= factory.$inject.length) {
			callback(args);
			return;
		}

		let name = factory.$inject[index];
		console.log(name, args);

		if (name in $values) {
			args[index] = $values[name];
			return invokeFactory(factory, args, index + 1, callback);
		}

		console.log("없을때??", name);

		$queue[name] = $queue[name] || [];
		$queue[name].push(arguments);

		if (name in $factories) {
			let f = createFactory($factories[name]);
			return invokeFactory(f, [], 0, function(args) {
				module.value(name, f(...args));
			});
		}
	}


	let $values = Object.create(null);
	let $factories = Object.create(null);
	let $queue = Object.create(null);

	let module = {};

	module.value = function(name, value) {
		$values[name] = value;

		if ($queue[name]) {
			let q = $queue[name].slice();
			$queue[name] = [];
			q.forEach(args => {
				invokeFactory(...args);
			});
		}

		return this;
	};

	module.factory = function(name, mixed) {
		$factories[name] = mixed;
		return this;
	};

	module.require = function(mixed) {
		let factory = createFactory(mixed);
		invokeFactory(factory, [], 0, function(args) {
			factory(...args);
		});
	};


</script>

</body>
</html>