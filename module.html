<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
</head>
<body>

<script>
function Register(value) {
	this.queue = Object.create(null);
	this.value = value || Object.create(null);
}

Register.prototype = {

	isDefined(name) {
		return name in this.value;
	},

	whenDefined(name, callback, ...args) {
		this.queue[name] = this.queue[name] || [];
		this.queue[name].push([callback, args]);

		if (name in this.value) {
			return callback(name, this.value[name], ...args);
		}
	},

	define(name, value) {
		this.value[name] = value;

		if (this.queue[name]) {
			this.queue[name].forEach(o => {
				let [callback, args] = o;
				callback(name, value, ...args);
			});
		}
	}
};


const $$values = new Register();
const $$factories = new Register();

function _makeFactory(fn) {
	/// @TODO: Array Factory... ["aaa", "ddd", function(a,b,c)]

	if (fn.$inject) {
		return fn;
	}

	let s = fn.toString();
	fn.$inject = s.slice(s.indexOf("(") + 1, s.indexOf(")")).split(/\s*,\s*/).filter(x => x);
	return fn;
}

function _invokeValue(name, value, index, args, fn) {
	args[index] = value;

	for (let k = 0; k < args.length; k++) {
		if (!(k in args)) return;
	}

	fn.apply(null, args);
}

function _invokeFactory(name, value, index, args, fn) {
	if ($$values.isDefined(name)) {
		return _invokeValue(name, value, index, args, fn);
	}

	function factory() {
		$$values.define(name, value.apply(null, arguments));
	}

	factory.$inject = value.$inject;

	$module.require(factory);
}


/// exports
function $module() {
	/// @TODO ...
}

$module.value = function(name, value) {
	$$values.define(name, value);
};

$module.factory = function(name, factory) {
	$$factories.define(name, _makeFactory(factory));
};

$module.require = function(fn) {
	fn = _makeFactory(fn);
	if (!fn.$inject.length) {
		fn();
		return;
	}

	let args = Array(fn.$inject.length);
	fn.$inject.forEach((name, index) => {
		$$factories.whenDefined(name, _invokeFactory, index, args, fn);
		$$values.whenDefined(name, _invokeValue, index, args, fn);
	});
};


$module.factory("name", function(a, b) {
	return function() {
		return "name function";
	}
});


$module.value("b", "B");


$module.require(function(a, b, name) {
	console.log("hello", a, b, name(), Math.random())
});


$module.value("c", "C");


$module.value("a", "A");


</script>
</body>
</html>