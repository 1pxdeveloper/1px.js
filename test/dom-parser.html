<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<!--<script src="js/observable.js"></script>-->
	<!--<script src="js/module.js"></script>-->
	<!--<script src="js/parse.js"></script>-->
	<!--<script src="js/compile.js"></script>-->
</head>
<body>


<h1 sks---abc="123" test hello [hidden]="true" my='aaaa' abc=123 456>{{ tit > le }}</h1>


<script id="main">
// let url = "../examples/todomvc-app/index.html";

url = "./dom-parser.html";

fetch(url).then(res => res.text()).then(html => {

	class $Node {
		constructor() {
			this.nodeName = null;
			this.nodeValue = null;
			this.nodeType = null;
			this.childNodes = [];
		}
	}

	class $Element extends $Node {
		constructor() {
			super();
			this.nodeType = 1;
			this.tagName = null;
			this.attrs = "";
			this.outerHTML = "";
		}

		appendChild(node) {
			this.childNodes.push(node);
		}
	}

	class $Text extends $Node {
		constructor(data) {
			super();
			this.nodeType = 3;
			this.nodeValue = data;
		}
	}

	function createElement(tagName) {
		let e = new $Element();
		e.tagName = tagName.trim();
		return e;
	}


	console.log(html);


	// let html = document.documentElement.outerHTML;
	// let html = `<div  id="skjdflksd"      >asdklf < jasklds</div>`

	// let string = `(?:'[^']*'|"[^"]*")`;


	/// <tag>

	/// <tag >

	/// <tag skjdsk >

	/// <tag or <tag(?:>|\s[^>]*>)

	/// ex) <!-- [^-]*|-[^-]*|--[^>]*|. -->

	// let tag_re = /([<]!--(?:.*?)-->)|(<script[^>]*>)|(<style(?:.*?)<[/]style>)|(<([^>\s]+)(\s+([^>]+))?>)|[^<]+|./g;


	let tagName = /(\/?)([^>\s]+)/.source;
	let tagAttrs = /((?:\s[^>]*)?)(\/)?/.source;
	let comment = /([<]!--(?:.*?)-->)/.source;

	let tag_re = new RegExp(`${comment}|(<${tagName}${tagAttrs}>)|[^<]*|.`, "g");

	let attrs_re = /\s*([^=\s]+)\s*(?:=\s*(?:'([^']+)'|"([^"]+)"|([^\s]+))\s*)?/g;


	let i = 0;

	let root = new $Element();
	root.tagName = "#root";
	let stack = [root];

	html.replace(tag_re, function(nodeValue, comment, outerHTML, closed, tagName, attrs) {
		let args = Array.from(arguments);

		if (comment) {
			return nodeValue;
		}

		/// Element Node
		if (tagName) {

			let parent = stack[stack.length - 1];

			if (parent.nodeType === 3) {
				stack.pop();
				parent = stack[stack.length - 1];
			}

			if (parent.tagName === "script" && !(tagName === "script" && closed)) {
				// console.log("script!", args);
				return nodeValue;
			}

			if (parent.tagName === "style" && !(tagName === "style" && closed)) {
				// console.log("style!", args);
				return nodeValue;
			}

			if (closed) {
				// @TODO: 같은 태그 이름이 나올때 까지 닫는게 맞는거...
				stack.pop();
				return nodeValue;
			}


			let el = createElement(tagName);
			el.outerHTML = outerHTML;

			if (attrs) {
				el.attrs = {};
				attrs.replace(attrs_re, function(a, name, str1, str2, value) {
					el.attrs[name] = str1 || str2 || value || "";
				});
			}

			parent.appendChild(el);


			// void Elements
			switch (tagName.toLowerCase()) {
				case "meta":
				case "link":
				case "input":
				case "hr":
					return nodeValue;
			}

			// !doctype ...
			if (tagName[0] === "!") {
				return nodeValue;
			}

			stack.push(el);
			return nodeValue;
		}

		/// Text Node
		if (!tagName) {
			let parent = stack[stack.length - 1];

			if (parent instanceof $Text) {
				parent.textContent += nodeValue;
			} else {
				let t = new $Text(nodeValue);
				parent.appendChild(t);
				stack.push(t);
			}
		}

		return nodeValue;
	});


	function render(e, tab) {
		switch (e.nodeType) {
			case 1:
				console.log(tab + e.outerHTML, e.tagName, e.attrs);
				e.childNodes.forEach(c => render(c, tab + "  "));
				console.log(tab + "</" + e.tagName + ">");
				break;

			case 3:
				if (e.nodeValue == true) {
					console.log(tab + e.nodeValue);
				}
				break;
		}
	}

	console.log(stack);

	render(root, "");
});
</script>


</body>
</html>